<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Privapp - Administração</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 25%, #dee2e6 50%, #e9ecef 75%, #f8f9fa 100%);
      background-size: 400% 400%;
      animation: gradientShift 10s ease infinite;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(26, 95, 60, 0.05) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(19, 74, 48, 0.05) 0%, transparent 50%),
                  radial-gradient(circle at 40% 40%, rgba(13, 58, 37, 0.03) 0%, transparent 50%);
      animation: float 8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(0.5deg); }
    }

    .admin-header {
      background: linear-gradient(135deg, #1a5f3c, #134a30);
      color: white;
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(26, 95, 60, 0.3);
      position: relative;
      overflow: hidden;
    }

    .admin-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      animation: slideInUp 0.6s ease-out;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-header {
      background: white;
      border-bottom: 1px solid #e9ecef;
      border-radius: 15px 15px 0 0 !important;
      padding: 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1a5f3c, #134a30);
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(26, 95, 60, 0.3);
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #134a30, #0d3a25);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(26, 95, 60, 0.4);
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:active {
      transform: translateY(0px) scale(0.98);
    }

    .table {
      margin-bottom: 0;
    }

    .table th {
      border-top: none;
      font-weight: 600;
      color: #495057;
      background: #f8f9fa;
    }

    .table td {
      vertical-align: middle;
      border-top: 1px solid #e9ecef;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .admin-badge {
      background: linear-gradient(135deg, #1a5f3c, #134a30);
      color: white;
      box-shadow: 0 2px 8px rgba(26, 95, 60, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .user-badge {
      background: #6c757d;
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-sm::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.3s;
    }

    .btn-sm:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-sm:hover::before {
      left: 100%;
    }

    .btn-sm:active {
      transform: translateY(0px) scale(0.95);
    }

    .modal-content {
      border-radius: 15px;
      border: none;
    }

    .modal-header {
      border-bottom: 1px solid #e9ecef;
      border-radius: 15px 15px 0 0;
    }

    .form-control {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
    }

    .form-control::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(26, 95, 60, 0.1), transparent);
      transition: left 0.5s;
    }

    .form-control:focus {
      border-color: #1a5f3c;
      box-shadow: 0 0 0 0.2rem rgba(26, 95, 60, 0.25), 0 4px 15px rgba(26, 95, 60, 0.1);
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 1);
    }

    .form-control:focus::before {
      left: 100%;
    }

    .alert {
      border-radius: 10px;
      border: none;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 24px;
    }

    .nav-link {
      color: rgba(255,255,255,0.8) !important;
      font-weight: 500;
    }

    .nav-link:hover {
      color: white !important;
    }

    .nav-link.active {
      color: white !important;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar navbar-expand-lg admin-header">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-shield-lock me-2"></i>
        Privapp Admin
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/" title="Ir para aplicação">
          <i class="bi bi-arrow-left me-1"></i>
          Voltar ao App
        </a>
        <a class="nav-link" href="/logout" title="Sair">
          <i class="bi bi-box-arrow-right me-1"></i>
          Sair
        </a>
      </div>
    </div>
  </nav>

  <div class="admin-container">
    <!-- Alertas -->
    <div id="alertContainer"></div>

    <!-- Card Principal -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-people me-2"></i>
          Gerenciamento de Usuários
        </h5>
        <div>
          <button class="btn btn-warning me-2" onclick="resetAdminPassword()">
            <i class="bi bi-key me-1"></i>
            Resetar Senha Admin
          </button>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-circle me-1"></i>
            Novo Usuário
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Email</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>Criado em</th>
                <th>Último Login</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="7" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Usuário -->
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-plus me-2"></i>
            Novo Usuário
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addUserForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">Usuário *</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Senha *</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirmar Senha *</label>
              <input type="password" class="form-control" id="confirmPassword" required>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="isAdmin">
              <label class="form-check-label" for="isAdmin">
                Usuário Administrador
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              <span class="btn-text">Criar Usuário</span>
              <span class="loading" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status"></span>
                Criando...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="confirmMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let users = [];
    let currentAction = null;
    let currentUserId = null;

    // Carregar usuários ao iniciar
    document.addEventListener('DOMContentLoaded', loadUsers);

    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        if (response.ok) {
          users = await response.json();
          renderUsers();
        } else {
          showAlert('Erro ao carregar usuários', 'danger');
        }
      } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro de conexão', 'danger');
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      
      if (users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4 text-muted">
              Nenhum usuário encontrado
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => `
        <tr>
          <td>
            <strong>${user.username}</strong>
          </td>
          <td>${user.email || '-'}</td>
          <td>
            <span class="status-badge ${user.is_admin ? 'admin-badge' : 'user-badge'}">
              ${user.is_admin ? 'Admin' : 'Usuário'}
            </span>
          </td>
          <td>
            <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
              ${user.is_active ? 'Ativo' : 'Inativo'}
            </span>
          </td>
          <td>${formatDate(user.created_at)}</td>
          <td>${user.last_login ? formatDate(user.last_login) : 'Nunca'}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-info" 
                      onclick="resetUserPassword(${user.id}, '${user.username}')" 
                      title="Redefinir senha">
                <i class="bi bi-key"></i>
              </button>
              ${user.is_admin ? '' : `
                <button class="btn btn-sm ${user.is_active ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleUserStatus(${user.id}, ${user.is_active})" 
                        title="${user.is_active ? 'Desativar' : 'Ativar'} usuário">
                  <i class="bi bi-${user.is_active ? 'pause' : 'play'}"></i>
                </button>
                <button class="btn btn-sm btn-danger" 
                        onclick="deleteUser(${user.id}, '${user.username}')" 
                        title="Excluir usuário">
                  <i class="bi bi-trash"></i>
                </button>
              `}
            </div>
          </td>
        </tr>
      `).join('');
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    // Formulário de adicionar usuário
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const isAdmin = document.getElementById('isAdmin').checked;
      
      if (password !== confirmPassword) {
        showAlert('As senhas não coincidem', 'danger');
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = submitBtn.querySelector('.btn-text');
      const loading = submitBtn.querySelector('.loading');
      
      btnText.style.display = 'none';
      loading.style.display = 'inline-block';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password, isAdmin })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showAlert('Usuário criado com sucesso!', 'success');
          document.getElementById('addUserForm').reset();
          bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
          loadUsers();
        } else {
          showAlert(data.error || 'Erro ao criar usuário', 'danger');
        }
      } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro de conexão', 'danger');
      } finally {
        btnText.style.display = 'inline';
        loading.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    async function toggleUserStatus(userId, currentStatus) {
      const action = currentStatus ? 'desativar' : 'ativar';
      const confirmed = confirm(`Tem certeza que deseja ${action} este usuário?`);
      
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/api/users/${userId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isActive: !currentStatus })
        });
        
        if (response.ok) {
          showAlert(`Usuário ${action === 'ativar' ? 'ativado' : 'desativado'} com sucesso!`, 'success');
          loadUsers();
        } else {
          showAlert('Erro ao atualizar status do usuário', 'danger');
        }
      } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro de conexão', 'danger');
      }
    }

    function deleteUser(userId, username) {
      const confirmed = confirm(`Tem certeza que deseja excluir o usuário "${username}"? Esta ação não pode ser desfeita.`);
      
      if (!confirmed) return;
      
      fetch(`/api/users/${userId}`, { method: 'DELETE' })
        .then(response => {
          if (response.ok) {
            showAlert('Usuário excluído com sucesso!', 'success');
            loadUsers();
          } else {
            showAlert('Erro ao excluir usuário', 'danger');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          showAlert('Erro de conexão', 'danger');
        });
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alertId = 'alert-' + Date.now();
      
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      alertContainer.insertAdjacentHTML('beforeend', alertHtml);
      
      // Auto-remover após 5 segundos
      setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }

    // Função para redefinir senha de usuário
    async function resetUserPassword(userId, username) {
      const confirmed = confirm(`Tem certeza que deseja redefinir a senha do usuário "${username}"?\n\nA nova senha será: 12345678\n\nO usuário será obrigado a trocar a senha no próximo login.`);
      
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/api/users/${userId}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showAlert(`Senha do usuário "${username}" redefinida com sucesso! Nova senha: 12345678`, 'success');
        } else {
          showAlert(data.error || 'Erro ao redefinir senha', 'danger');
        }
      } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro de conexão', 'danger');
      }
    }

    // Função para redefinir senha do admin
    async function resetAdminPassword() {
      const confirmed = confirm('Tem certeza que deseja redefinir a senha do administrador?\n\nA nova senha será: admin2509\n\nO admin será obrigado a trocar a senha no próximo login.');
      
      if (!confirmed) return;
      
      try {
        const response = await fetch('/api/admin/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showAlert('Senha do administrador redefinida com sucesso! Nova senha: admin2509', 'success');
        } else {
          showAlert(data.error || 'Erro ao redefinir senha do admin', 'danger');
        }
      } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro de conexão', 'danger');
      }
    }
  </script>
</body>
</html> 